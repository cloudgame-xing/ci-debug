name: CI
on: [push]
jobs:
  build:
    runs-on: windows-11-arm
    steps:
      - name: check env
        shell: pwsh
        run: |
          #Requires -Version 5.1
          <#
          .SYNOPSIS
              GitHub Actions Windows Runner 环境诊断脚本
          #>
          
          $ErrorActionPreference = 'Continue'
          $separator = "=" * 70
          
          function Write-Section($title) {
              Write-Host "`n$separator" -ForegroundColor Cyan
              Write-Host " $title" -ForegroundColor Cyan
              Write-Host "$separator" -ForegroundColor Cyan
          }
          
          # ============================================================
          #  1. 操作系统 & 硬件
          # ============================================================
          Write-Section "操作系统 & 硬件配置"
          
          $os = Get-CimInstance Win32_OperatingSystem
          $cpu = Get-CimInstance Win32_Processor
          $disk = Get-CimInstance Win32_LogicalDisk -Filter "DriveType=3"
          
          Write-Host "`n[OS]"
          Write-Host "  系统名称   : $($os.Caption) ($($os.OSArchitecture))"
          Write-Host "  版本号     : $($os.Version) (Build $($os.BuildNumber))"
          Write-Host "  计算机名   : $env:COMPUTERNAME"
          
          Write-Host "`n[CPU]"
          Write-Host "  型号       : $($cpu.Name)"
          Write-Host "  核心/线程  : $($cpu.NumberOfCores) 核 / $($cpu.NumberOfLogicalProcessors) 线程"
          Write-Host "  最大频率   : $($cpu.MaxClockSpeed) MHz"
          Write-Host "  架构       : $(switch($cpu.Architecture){ 0{'x86'} 5{'ARM'} 9{'x64'} 12{'ARM64'} default{$cpu.Architecture} })"
          
          Write-Host "`n[内存]"
          $totalGB = [math]::Round($os.TotalVisibleMemorySize / 1MB, 1)
          $freeGB  = [math]::Round($os.FreePhysicalMemory / 1MB, 1)
          Write-Host "  总内存     : ${totalGB} GB"
          Write-Host "  可用内存   : ${freeGB} GB"
          
          Write-Host "`n[磁盘]"
          foreach ($d in $disk) {
              $sizeGB = [math]::Round($d.Size / 1GB, 1)
              $freeGB = [math]::Round($d.FreeSpace / 1GB, 1)
              Write-Host "  $($d.DeviceID)  总计 ${sizeGB} GB / 可用 ${freeGB} GB"
          }
          
          # ============================================================
          #  2. Visual Studio（vswhere 原始输出）
          # ============================================================
          Write-Section "Visual Studio 安装情况 (vswhere)"
          
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          
          if (Test-Path $vswhere) {
              Write-Host "`n--- 基本信息 ---`n"
              & $vswhere -all -products *
          
              Write-Host "`n--- 已安装的组件列表 ---`n"
              & $vswhere -all -products * -include packages -find "**"
          
              # 单独列出 VC 相关组件，方便快速确认
              Write-Host "`n--- VC / C++ 相关组件 (过滤) ---`n"
              $pkgs = & $vswhere -latest -include packages -format json | ConvertFrom-Json
              if ($pkgs -and $pkgs[0].packages) {
                  $pkgs[0].packages |
                      Where-Object { $_.id -match '\.VC\.|MSVC|CMake|Ninja' } |
                      Sort-Object id |
                      ForEach-Object { Write-Host "  $($_.id)  ($($_.version))" }
              } else {
                  Write-Host "  (无法获取组件列表，以上 -find 输出可作为替代)" -ForegroundColor Yellow
              }
          } else {
              Write-Host "  vswhere.exe 未找到" -ForegroundColor Red
          }
          
          # ============================================================
          #  3. CMake
          # ============================================================
          Write-Section "CMake"
          
          $cmakePath = Get-Command cmake -ErrorAction SilentlyContinue
          if ($cmakePath) {
              Write-Host "  路径 : $($cmakePath.Source)"
              & cmake --version | Select-Object -First 1 | ForEach-Object { Write-Host "  $_" }
          } else {
              Write-Host "  ❌ 未安装" -ForegroundColor Red
          }
          
          # ============================================================
          #  4. Ninja
          # ============================================================
          Write-Section "Ninja"
          
          $ninjaPath = Get-Command ninja -ErrorAction SilentlyContinue
          if ($ninjaPath) {
              Write-Host "  路径 : $($ninjaPath.Source)"
              Write-Host "  版本 : $(& ninja --version)"
          } else {
              Write-Host "  PATH 中未找到" -ForegroundColor Yellow
              # 检查 VS 内置
              if (Test-Path $vswhere) {
                  $installPath = & $vswhere -latest -property installationPath
                  $vsNinja = Join-Path $installPath "Common7\IDE\CommonExtensions\Microsoft\CMake\Ninja\ninja.exe"
                  if (Test-Path $vsNinja) {
                      Write-Host "  VS 内置 : $vsNinja ($(& $vsNinja --version))" -ForegroundColor Yellow
                  }
              }
          }
          
          # ============================================================
          #  5. 其他工具
          # ============================================================
          Write-Section "其他工具"
          
          $tools = @(
              @{ Name = "git";       Cmd = "git --version" },
              @{ Name = "python";    Cmd = "python --version" },
              @{ Name = "clang";     Cmd = "clang --version" },
              @{ Name = "clang-cl";  Cmd = "clang-cl --version" },
              @{ Name = "gcc";       Cmd = "gcc --version" },
              @{ Name = "rustc";     Cmd = "rustc --version" },
              @{ Name = "node";      Cmd = "node --version" },
              @{ Name = "nasm";      Cmd = "nasm -v" },
              @{ Name = "7z";        Cmd = "7z" }
          )
          
          foreach ($tool in $tools) {
              $exe = Get-Command $tool.Name -ErrorAction SilentlyContinue
              if ($exe) {
                  try {
                      $ver = (Invoke-Expression $tool.Cmd 2>&1) | Select-Object -First 1
                      Write-Host ("  {0,-12} : ✅  {1}" -f $tool.Name, $ver)
                  } catch {
                      Write-Host ("  {0,-12} : ✅  {1}" -f $tool.Name, $exe.Source)
                  }
              } else {
                  Write-Host ("  {0,-12} : --" -f $tool.Name) -ForegroundColor DarkGray
              }
          }
          
          # ============================================================
          #  6. 关键环境变量
          # ============================================================
          Write-Section "关键环境变量"
          
          $envVars = @(
              "RUNNER_OS", "RUNNER_ARCH", "ImageOS", "ImageVersion",
              "VCPKG_INSTALLATION_ROOT", "GITHUB_WORKSPACE"
          )
          
          foreach ($var in $envVars) {
              $val = [Environment]::GetEnvironmentVariable($var)
              if ($val) {
                  Write-Host ("  {0,-25} : {1}" -f $var, $val)
              } else {
                  Write-Host ("  {0,-25} : (未设置)" -f $var) -ForegroundColor DarkGray
              }
          }
          
          # ============================================================
          Write-Host "`n$separator" -ForegroundColor Cyan
          Write-Host " 诊断完成  $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Cyan
          Write-Host "$separator`n" -ForegroundColor Cyan
